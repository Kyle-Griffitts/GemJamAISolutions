@page "/analysis"
@using GemJamAISolutions.Client.Services
@using GemJamAISolutions.Client.Models
@using System.Net.Http.Json
@inject AuthService AuthService
@inject NavigationManager Navigation
@inject HttpClient HttpClient

<PageTitle>FloodReady AI - Risk Analysis</PageTitle>

<div class="analysis-container min-vh-100 py-4 py-md-5">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-12 col-lg-10 col-xl-9">
                <!-- Header -->
                <div class="d-flex align-items-center justify-content-between mb-4 gap-2">
                    <div class="d-flex align-items-center gap-2">
                        <button class="btn btn-link text-white text-decoration-none p-2 btn-back" @onclick="GoBack">
                            <span class="fs-4">&larr;</span>
                        </button>
                        <h1 class="fs-3 fs-md-2 fw-bold text-white mb-0">Flood Risk Analysis</h1>
                    </div>
                    <button class="btn btn-light btn-sm rounded-3 fw-semibold d-none d-md-flex align-items-center gap-2" @onclick="GoToHeatmap">
                        üó∫Ô∏è View Heatmap <span>&rarr;</span>
                    </button>
                </div>

                <!-- Mobile Heatmap Button -->
                <div class="d-md-none mb-3">
                    <button class="btn btn-light w-100 rounded-3 fw-semibold d-flex align-items-center justify-content-center gap-2" @onclick="GoToHeatmap">
                        üó∫Ô∏è View Flood Risk Heatmap <span>&rarr;</span>
                    </button>
                </div>

                <!-- High Risk Alert -->
                <div class="bg-white rounded-4 shadow-lg p-3 p-md-4 mb-3">
                    @if (floodRiskResult == null)
                    {
                        <div class="text-center py-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    }
                    else
                    {
                        <div class="d-flex align-items-start gap-3 mb-3">
                            <span class="fs-1">@(floodRiskResult.IsInFloodZone == true ? "‚ö†Ô∏è" : "‚ÑπÔ∏è")</span>
                            <div class="flex-grow-1">
                                <h2 class="fs-4 fw-semibold @(floodRiskResult.IsInFloodZone == true ? "text-danger" : "text-info") mb-2">
                                    @(floodRiskResult.IsInFloodZone == true ? "Flood Risk Detected" : "Flood Risk Analysis")
                                </h2>
                                <p class="text-dark mb-0">@floodRiskResult.ModelResponse</p>
                            </div>
                        </div>
                        @if (floodRiskResult.IsInFloodZone == true)
                        {
                            <div class="bg-danger bg-opacity-10 rounded-3 p-3">
                                <p class="small text-danger mb-2 fw-semibold">‚è∞ Immediate Action Recommended</p>
                                <p class="small text-dark mb-0">Heavy rainfall is forecasted within the next 24-48 hours. Consider evacuating to higher ground if flooding begins.</p>
                            </div>
                        }
                    }
                </div>

                <!-- Risk Factors -->
                <div class="bg-white rounded-4 shadow-lg p-3 p-md-4 mb-3">
                    <h3 class="fs-5 fw-semibold text-dark mb-3">Risk Factors</h3>
                    <div class="row g-3">
                        <div class="col-12 col-md-6">
                            <div class="bg-light rounded-3 p-3">
                                <div class="d-flex align-items-center justify-content-between mb-2">
                                    <span class="small fw-medium text-secondary">Elevation Level</span>
                                    <span class="badge bg-danger">High Risk</span>
                                </div>
                                <div class="progress mb-2" style="height: 8px;">
                                    <div class="progress-bar bg-danger" role="progressbar" style="width: 85%" aria-valuenow="85" aria-valuemin="0" aria-valuemax="100"></div>
                                </div>
                                <p class="small text-muted mb-0">Your location is in a low-lying area prone to flooding</p>
                            </div>
                        </div>
                        <div class="col-12 col-md-6">
                            <div class="bg-light rounded-3 p-3">
                                <div class="d-flex align-items-center justify-content-between mb-2">
                                    <span class="small fw-medium text-secondary">Rainfall Forecast</span>
                                    <span class="badge bg-warning text-dark">Moderate</span>
                                </div>
                                <div class="progress mb-2" style="height: 8px;">
                                    <div class="progress-bar bg-warning" role="progressbar" style="width: 65%" aria-valuenow="65" aria-valuemin="0" aria-valuemax="100"></div>
                                </div>
                                <p class="small text-muted mb-0">4-6 inches of rain expected in next 48 hours</p>
                            </div>
                        </div>
                        <div class="col-12 col-md-6">
                            <div class="bg-light rounded-3 p-3">
                                <div class="d-flex align-items-center justify-content-between mb-2">
                                    <span class="small fw-medium text-secondary">Drainage System</span>
                                    <span class="badge bg-danger">High Risk</span>
                                </div>
                                <div class="progress mb-2" style="height: 8px;">
                                    <div class="progress-bar bg-danger" role="progressbar" style="width: 75%" aria-valuenow="75" aria-valuemin="0" aria-valuemax="100"></div>
                                </div>
                                <p class="small text-muted mb-0">Drainage capacity may be overwhelmed</p>
                            </div>
                        </div>
                        <div class="col-12 col-md-6">
                            <div class="bg-light rounded-3 p-3">
                                <div class="d-flex align-items-center justify-content-between mb-2">
                                    <span class="small fw-medium text-secondary">Historical Data</span>
                                    <span class="badge bg-warning text-dark">Moderate</span>
                                </div>
                                <div class="progress mb-2" style="height: 8px;">
                                    <div class="progress-bar bg-warning" role="progressbar" style="width: 60%" aria-valuenow="60" aria-valuemin="0" aria-valuemax="100"></div>
                                </div>
                                <p class="small text-muted mb-0">3 flood events in past 5 years</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Evacuation Centers -->
                <div class="bg-white rounded-4 shadow-lg p-3 p-md-4 mb-3">
                    <h3 class="fs-5 fw-semibold text-dark mb-3">üè¢ Nearby Evacuation Centers</h3>
                    @if (shelters == null)
                    {
                        <div class="text-center py-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    }
                    else if (shelters.Count == 0)
                    {
                        <p class="text-muted">No evacuation centers found.</p>
                    }
                    else
                    {
                        <div class="list-group list-group-flush">
                            @foreach (var shelter in shelters)
                            {
                                <div class="list-group-item px-0 py-3">
                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                        <div>
                                            <h4 class="fs-6 fw-semibold text-dark mb-1">@shelter.Name</h4>
                                            <p class="small text-secondary mb-1">
                                                üìç @shelter.Address, @shelter.City, @shelter.State @shelter.ZipCode
                                                @if (shelter.DistanceMiles.HasValue && shelter.TravelTimeMinutes.HasValue)
                                                {
                                                    <span class="fw-bold text-primary"> ‚Ä¢ @shelter.DistanceMiles.Value.ToString("F1") mi ‚Ä¢ ~@Math.Round(shelter.TravelTimeMinutes.Value) min</span>
                                                }
                                            </p>
                                        </div>
                                        @if (shelter.OpenedDate.HasValue)
                                        {
                                            <span class="badge bg-success">Open</span>
                                        }
                                        else
                                        {
                                            <span class="badge bg-secondary">Standby</span>
                                        }
                                    </div>
                                    <p class="small text-muted mb-0">
                                        @(shelter.ShelterType == 1 ? "Special Needs Shelter" : "General Population Shelter")
                                        @if (shelter.IsPetFriendly)
                                        {
                                            <span> ‚Ä¢ üêæ Pet-friendly</span>
                                        }
                                    </p>
                                </div>
                            }
                        </div>
                    }
                </div>

                <!-- Sandbag Locations -->
                <div class="bg-white rounded-4 shadow-lg p-3 p-md-4 mb-3">
                    <h3 class="fs-5 fw-semibold text-dark mb-3">ü™® Sandbag Distribution Points</h3>
                    @if (sandbagDistributions == null)
                    {
                        <div class="text-center py-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    }
                    else if (sandbagDistributions.Count == 0)
                    {
                        <p class="text-muted">No sandbag distribution points found.</p>
                    }
                    else
                    {
                        <div class="row g-3">
                            @foreach (var distribution in sandbagDistributions)
                            {
                                <div class="col-12 col-md-6">
                                    <div class="bg-light rounded-3 p-3">
                                        <h4 class="fs-6 fw-semibold text-dark mb-2">
                                            @distribution.Name
                                            @if (distribution.DistanceMiles.HasValue && distribution.TravelTimeMinutes.HasValue)
                                            {
                                                <span class="badge bg-primary ms-2">@distribution.DistanceMiles.Value.ToString("F1") mi ‚Ä¢ ~@Math.Round(distribution.TravelTimeMinutes.Value) min</span>
                                            }
                                        </h4>
                                        <p class="small text-secondary mb-2">üìç @distribution.Address, @distribution.City, @distribution.State @distribution.ZipCode</p>
                                        <p class="small text-muted mb-2">
                                            Free sandbags available (limit @distribution.MaxSandbagsPerResident per household)
                                            @if (distribution.BringOwnShovel)
                                            {
                                                <span> ‚Ä¢ Bring your own shovel</span>
                                            }
                                        </p>
                                        @if (distribution.AvailableFrom.HasValue && distribution.AvailableUntil.HasValue)
                                        {
                                            <span class="badge bg-info text-dark">Open: @distribution.AvailableFrom.Value.ToString("MMM d") - @distribution.AvailableUntil.Value.ToString("MMM d, yyyy")</span>
                                        }
                                        else
                                        {
                                            <span class="badge bg-success">Active</span>
                                        }
                                    </div>
                                </div>
                            }
                        </div>
                    }
                </div>

                <!-- Safety Tips -->
                <div class="bg-white rounded-4 shadow-lg p-3 p-md-4 mb-3">
                    <h3 class="fs-5 fw-semibold text-dark mb-3">‚úÖ Recommended Safety Actions</h3>
                    <div class="row g-3">
                        <div class="col-12 col-md-6">
                            <div class="d-flex gap-3">
                                <span class="text-success fs-4">‚úì</span>
                                <div>
                                    <h4 class="fs-6 fw-semibold text-dark mb-1">Prepare Emergency Kit</h4>
                                    <p class="small text-muted mb-0">Include water, food, medications, flashlight, batteries, first aid, important documents</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-12 col-md-6">
                            <div class="d-flex gap-3">
                                <span class="text-success fs-4">‚úì</span>
                                <div>
                                    <h4 class="fs-6 fw-semibold text-dark mb-1">Move Valuables to Higher Ground</h4>
                                    <p class="small text-muted mb-0">Relocate important items to upper floors or elevated surfaces</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-12 col-md-6">
                            <div class="d-flex gap-3">
                                <span class="text-success fs-4">‚úì</span>
                                <div>
                                    <h4 class="fs-6 fw-semibold text-dark mb-1">Turn Off Utilities If Flooding Begins</h4>
                                    <p class="small text-muted mb-0">Shut off electricity and gas to prevent hazards</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-12 col-md-6">
                            <div class="d-flex gap-3">
                                <span class="text-success fs-4">‚úì</span>
                                <div>
                                    <h4 class="fs-6 fw-semibold text-dark mb-1">Stay Informed</h4>
                                    <p class="small text-muted mb-0">Monitor weather alerts and local emergency broadcasts</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-12 col-md-6">
                            <div class="d-flex gap-3">
                                <span class="text-success fs-4">‚úì</span>
                                <div>
                                    <h4 class="fs-6 fw-semibold text-dark mb-1">Never Walk or Drive Through Flood Water</h4>
                                    <p class="small text-muted mb-0">6 inches of moving water can knock you down; 12 inches can carry away a vehicle</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-12 col-md-6">
                            <div class="d-flex gap-3">
                                <span class="text-success fs-4">‚úì</span>
                                <div>
                                    <h4 class="fs-6 fw-semibold text-dark mb-1">Charge All Devices</h4>
                                    <p class="small text-muted mb-0">Keep phones and emergency devices fully charged</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Emergency Contacts -->
                <div class="bg-white rounded-4 shadow-lg p-3 p-md-4">
                    <h3 class="fs-5 fw-semibold text-dark mb-3">üìû Emergency Contacts</h3>
                    <div class="row g-3">
                        <div class="col-12 col-sm-6 col-md-4">
                            <div class="text-center p-3 bg-light rounded-3">
                                <p class="small fw-medium text-secondary mb-1">Emergency Services</p>
                                <p class="fs-5 fw-bold text-dark mb-0">911</p>
                            </div>
                        </div>
                        <div class="col-12 col-sm-6 col-md-4">
                            <div class="text-center p-3 bg-light rounded-3">
                                <p class="small fw-medium text-secondary mb-1">Non-Emergency</p>
                                <p class="fs-5 fw-bold text-dark mb-0">311</p>
                            </div>
                        </div>
                        <div class="col-12 col-sm-6 col-md-4">
                            <div class="text-center p-3 bg-light rounded-3">
                                <p class="small fw-medium text-secondary mb-1">Red Cross</p>
                                <p class="fs-5 fw-bold text-dark mb-0">1-800-733-2767</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    [SupplyParameterFromQuery]
    public double? Lat { get; set; }

    [SupplyParameterFromQuery]
    public double? Lon { get; set; }

    [SupplyParameterFromQuery]
    public string? Address { get; set; }

    private List<ShelterWithDistance>? shelters;
    private List<SandbagDistributionWithDistance>? sandbagDistributions;
    private FloodRiskResult? floodRiskResult;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var baseUri = Navigation.BaseUri;
            Console.WriteLine($"Base URI: {baseUri}");
            Console.WriteLine($"Lat: {Lat}, Lon: {Lon}, Address: {Address}");

            // Fetch flood risk data
            floodRiskResult = await HttpClient.GetFromJsonAsync<FloodRiskResult>($"{baseUri}api/data/flood-risk/latest");

            // If we have user coordinates from query params, fetch nearest locations sorted by distance
            if (Lat.HasValue && Lon.HasValue)
            {
                Console.WriteLine($"Fetching nearest shelters for lat={Lat.Value}, lon={Lon.Value}");
                // Fetch shelters sorted by distance
                shelters = await HttpClient.GetFromJsonAsync<List<ShelterWithDistance>>($"{baseUri}api/data/shelters/nearest?lat={Lat.Value}&lon={Lon.Value}");
                Console.WriteLine($"Fetched {shelters?.Count ?? 0} shelters");

                // Fetch sandbag distributions sorted by distance
                sandbagDistributions = await HttpClient.GetFromJsonAsync<List<SandbagDistributionWithDistance>>($"{baseUri}api/data/sandbag-distributions/nearest?lat={Lat.Value}&lon={Lon.Value}");
                Console.WriteLine($"Fetched {sandbagDistributions?.Count ?? 0} sandbag distributions");
            }
            else
            {
                Console.WriteLine("No coordinates provided, fetching all locations");
                // Fallback: fetch all locations without distance sorting
                var allShelters = await HttpClient.GetFromJsonAsync<List<Shelter>>($"{baseUri}api/data/shelters");
                Console.WriteLine($"Fetched {allShelters?.Count ?? 0} shelters (no distance)");
                shelters = allShelters?.Select(s => new ShelterWithDistance
                {
                    Id = s.Id,
                    Name = s.Name,
                    Address = s.Address,
                    City = s.City,
                    State = s.State,
                    ZipCode = s.ZipCode,
                    Latitude = s.Latitude,
                    Longitude = s.Longitude,
                    ShelterType = (int)s.ShelterType,
                    IsPetFriendly = s.IsPetFriendly,
                    OpenedDate = s.OpenedDate,
                    DistanceMiles = null
                }).ToList();

                var allDistributions = await HttpClient.GetFromJsonAsync<List<SandbagDistribution>>($"{baseUri}api/data/sandbag-distributions");
                Console.WriteLine($"Fetched {allDistributions?.Count ?? 0} sandbag distributions (no distance)");
                sandbagDistributions = allDistributions?.Select(d => new SandbagDistributionWithDistance
                {
                    Id = d.Id,
                    Name = d.Name,
                    Address = d.Address,
                    City = d.City,
                    State = d.State,
                    ZipCode = d.ZipCode,
                    Latitude = d.Latitude,
                    Longitude = d.Longitude,
                    MaxSandbagsPerResident = d.MaxSandbagsPerResident,
                    BringOwnShovel = d.BringOwnShovel,
                    AvailableFrom = d.AvailableFrom,
                    AvailableUntil = d.AvailableUntil,
                    IsActive = d.IsActive,
                    DistanceMiles = null
                }).ToList();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading data: {ex.Message}");
            Console.WriteLine($"Stack trace: {ex.StackTrace}");
            Console.WriteLine($"Inner exception: {ex.InnerException?.Message}");
            shelters = new List<ShelterWithDistance>();
            sandbagDistributions = new List<SandbagDistributionWithDistance>();
        }
    }

    private void GoBack()
    {
        Navigation.NavigateTo("/");
    }

    private void GoToHeatmap()
    {
        Navigation.NavigateTo("/heatmap");
    }
}
